

// Interpolated values from the vertex shaders
in vec2 UV;

// Ouput data
layout(location = 0) out vec4 color;

// Values that stay constant for the whole mesh.
uniform sampler2D FRGBA;
uniform sampler2D FNormal;
uniform sampler2D FDepth;

#define SAMPLES 32

const vec3[] sphereSamples = vec3[](
vec3(0.16580879962563258,0.08781841767319233,0.5528851388174568)
,
vec3(0.12113278844640414,-0.5088561795993717,0.019950265377642364)
,
vec3(0.17242824507342688,-0.41963683414514025,0.4570061046894148)
,
vec3(-0.2227233597915129,0.3743270484566121,-0.0037300364251891087)
,
vec3(0.034242790221742536,-0.0010801674450238972,0.392792523540057)
,
vec3(-0.1336300094669588,0.1238394773129277,-0.09417595160018483)
,
vec3(-0.06376420040663154,0.3092566118377289,-0.6185919332079898)
,
vec3(-0.4620495119894338,-0.07078228929504403,-0.4326579352347501)
,
vec3(-0.007737800811213,-0.4992176621265767,-0.0028891049299540096)
,
vec3(-0.9284554963017975,-0.027580223642587366,-0.05233140388986737)
,
vec3(0.13037896893707457,-0.03439856090825921,0.3524315213947657)
,
vec3(-0.4909371538206744,0.025554768713558173,-0.4352502139693204)
,
vec3(-0.4393490824970918,0.04865179976956622,-0.343915427555277)
,
vec3(0.20863904682665818,-0.08520787307960487,0.09923984955535584)
,
vec3(0.013384162987756331,0.11685687717705011,0.04680157138335935)
,
vec3(0.24302228016319644,-0.08089174958981715,0.3374064831406314)
,
vec3(0.00489837769489993,-5.064978354626726e-05,0.2914941880167159)
,
vec3(-0.3021884116613342,-0.07742525761591805,-0.38229124609990617)
,
vec3(0.016088075448211222,0.17933316440270902,0.18341776942636964)
,
vec3(0.10841144278717815,-0.04989417594847577,0.3443414593753969)
,
vec3(0.10308158106216708,0.0319826433802944,0.24975370336666664)
,
vec3(0.012003383899152032,-0.2662651456622702,0.025280805495541563)
,
vec3(0.012173658483027008,-0.11738492491722724,0.04346145319167256)
,
vec3(0.05120963671828719,-0.32662659855581666,0.0847493719750143)
,
vec3(-0.45432901651734386,0.1825769623200575,-0.08338899620989908)
,
vec3(-0.06885655285148695,-0.09163686937318755,-0.15837523221285835)
,
vec3(0.07475670838324429,0.01990914119215346,0.7100093835358325)
,
vec3(0.06422765300612271,-0.00269354483176592,0.7417085009007698)
,
vec3(0.058247073060436916,0.15903519258435517,0.6048317252275781)
,
vec3(0.08890211651589877,0.028332840084953632,0.10611453882503631)
,
vec3(-0.3339453469872244,0.23354994081630195,-0.6134861956920314)
,
vec3(0.20835500850814945,-0.384662470602138,0.2636364465837867)
,
vec3(0.10825687812362139,0.26695440017442224,0.6358841103365828)
,
vec3(-0.4684124199533473,0.06950470625094313,-0.40436210439972226)
,
vec3(0.0036731910051382645,0.06958319276065442,0.28099295748771624)
,
vec3(0.26512807401118316,0.029527703932434327,0.20813226878518803)
,
vec3(0.1027374739270007,0.009836073073900805,0.15641230606671827)
,
vec3(-0.04062129464098815,0.445356011847237,-0.6363530486512071)
,
vec3(-0.28025335620426983,0.20716539478807594,-0.3039454412105097)
,
vec3(-0.06395772497550979,-0.36678036961634225,-0.5453417301514202)
,
vec3(-0.09516180239196705,-0.1724506865386435,-0.010405004831460209)
,
vec3(0.15950527376548726,0.1477446608532677,0.21084990139721696)
,
vec3(0.22270460998595645,0.08699218002461427,0.5414076378645655)
,
vec3(-0.2847712262050744,-0.20528733244227004,-0.19336056133685406)
,
vec3(-0.30935606439439806,-0.09611321147303226,-0.961753548871136)
,
vec3(-0.32246351395470535,-0.032464332971100684,-0.6288527263953436)
,
vec3(0.11726566013753938,-0.4021165373635783,0.0031202144175480066)
,
vec3(-0.34238645207721063,-0.5909719396604906,-0.0057914415853765455)
,
vec3(0.02762757398612109,0.0009369887917741643,0.19379615094755495)
,
vec3(-0.015429156771372288,-0.6480206978436149,-0.03148151941530678)
,
vec3(-0.6615593478335373,0.21309695509156554,-0.5446540283071679)
,
vec3(-0.1450485857878617,-0.322434300864902,-0.04593800670233244)
,
vec3(0.2565226030894762,0.19070473810842892,0.30067822927606747)
,
vec3(0.250425136949367,-0.36859107487086423,0.23004842598258055)
,
vec3(0.15618273571956848,0.19238336540457082,0.1878644351589326)
,
vec3(0.17177088925403663,-0.16187131906918178,0.012246481842818697)
,
vec3(0.16186067995490835,-0.23170127858150164,0.40380467561771427)
,
vec3(0.18196652897390364,0.024450671125064095,0.09007206979945191)
,
vec3(-0.010763511596278849,0.261139573740531,-0.3932603369277143)
,
vec3(-0.4970887160673288,0.24366960309207825,-0.25237965145475294)
,
vec3(0.007306201217945104,0.35648221379719397,0.019671886329138386)
,
vec3(0.07701192012413577,0.25060584884372844,0.19205304171466525)
,
vec3(0.004949264953742145,0.1509095720418296,0.07950188795935702)
,
vec3(0.13424118071282515,0.32424717476603515,0.18778088113099695)
,
vec3(0.01603075105945152,0.16552695748461568,0.27528521966818026)
,
vec3(-0.11325160284030027,-0.1746870536776884,-0.33124431773027946)
,
vec3(0.0917220832960255,-0.11158379882065594,0.21234133090875718)
,
vec3(0.15541896884810324,0.21022843859487503,0.07587266889407204)
,
vec3(-0.39417325282710947,-0.4634453045052457,-0.2512898352860556)
,
vec3(0.026940982717530936,-0.017473060976981127,0.3437705251914293)
,
vec3(0.047355582447644096,-0.6689448223919503,0.0332227865606425)
,
vec3(-0.35983854569664375,-0.2274600890346714,-0.3156914486063855)
,
vec3(-0.4992447489027853,-0.040472071184097715,-0.6111537522448948)
,
vec3(0.013795953888977992,0.020807841718169358,0.7410982706055941)
,
vec3(-0.3419396992055756,0.18034312315703022,-0.14039774093489493)
,
vec3(-0.2647510259104691,0.5280814316558374,-0.14017288121668245)
,
vec3(0.1783306337129365,0.2670296638306787,0.3374571035336039)
,
vec3(0.09348817404553648,-0.07632971831046868,0.15132715311066963)
,
vec3(0.018498385120522126,-0.39182483275553737,0.10477715118805801)
,
vec3(-0.6567595506913629,0.14174401423699445,-0.4270612945237743)
,
vec3(-0.013024021047913439,-0.5390833184325546,-0.0295235505718335)
,
vec3(0.029548353826109153,0.3422168345400335,0.07342099638192869)
,
vec3(-0.9103307405088608,0.10925650387309625,-0.6078415462323289)
,
vec3(-0.2053708223346437,-0.5531985424338843,-0.058949552240354676)
,
vec3(0.257195055262843,-0.03669997282935945,0.038558775947410424)
,
vec3(-0.021754689724343208,0.4719735806824344,-0.008101622127271238)
,
vec3(0.13306924940120682,0.0077296351350634035,0.6793130124206411)
,
vec3(-0.4705104420271112,0.26449874226411063,-0.5294287301788821)
,
vec3(-0.4432048685114466,-0.020654445937063816,-0.41828383478763287)
,
vec3(0.07975222679910776,0.027886291917990677,0.3148214593596745)
,
vec3(0.09788130181123345,0.07272878128085918,0.3718386656519987)
,
vec3(0.1406670825554458,0.023667347537492632,0.07307162534088044)
,
vec3(0.06574929739550928,0.04425720540156908,0.683887547685091)
,
vec3(-0.7019333796078141,0.06834159528198464,-0.3516123271808984)
,
vec3(-0.07953395460767225,-0.040954429710808725,-0.9508950115266812)
,
vec3(0.13940329501520263,-0.5065017898370231,0.27468972845141965)
,
vec3(-0.7971259192266311,-0.20681350170338622,-0.4330092723510927)
,
vec3(-0.1334300506029339,0.2304126014501254,-0.10046946954672158)
,
vec3(0.004372262480859321,0.020998362738021543,0.716067219456675)
,
vec3(0.1771723002641595,-0.3688860834091264,0.05089512022636521)
,
vec3(-0.05719862039089314,-0.6972637144104545,-0.013858360488384834)
,
vec3(0.19220608011282378,-0.12317949638457103,0.5769292538647669)
,
vec3(0.11466115450450268,0.12419277785133861,0.09896270814320295)
,
vec3(0.005409823238102758,0.00011047015895582126,0.7508403807594358)
,
vec3(-0.15595078813015073,-0.06425012102921658,-0.11993840012842875)
,
vec3(-0.6835692022296143,-0.08007704311257469,-0.5666178526784028)
,
vec3(0.02309953803526281,-0.1964368859108331,0.20696116703677522)
,
vec3(-0.019127990492544926,0.6735901194947135,-0.005667014795612797)
,
vec3(0.02187192860680958,-0.019884065408170934,0.9573715693400909)
,
vec3(-0.012551160696758018,0.5823647351484601,-0.22098409602896787)
,
vec3(0.23887260914782946,-0.14850893412580146,0.6991610530302776)
,
vec3(-0.6921996798136183,-0.256396422498898,-0.36173025773321876)
,
vec3(-0.09970304511435801,-0.09893683836171263,-0.5280861576233148)
,
vec3(-0.413125622389814,0.2507412960961577,-0.6059162333330542)
,
vec3(0.07711262151824544,0.03784713408213007,0.054801300559545435)
,
vec3(0.06581063172108392,-0.0027152363634058182,0.2813529085847283)
,
vec3(0.014682445666725982,-0.3586602277723106,0.11850361470103099)
,
vec3(-0.12542089964040073,-0.10466948881717586,-0.09135697283911734)
,
vec3(0.14868698334214767,0.06990773396727301,0.5521791447013863)
,
vec3(0.09197352187508809,-0.08448807053482196,0.37890299565111507)
,
vec3(-0.15355446467123768,-0.45030713057247906,-0.14103836318707547)
,
vec3(-0.04411320744686796,-0.5744155879697278,-0.03668077941280959)
,
vec3(-0.19028668060423368,-0.2795720236684291,-0.17287386011276523)
,
vec3(0.05109155193695568,-0.0018077854000851,0.8191555702800848)
,
vec3(-0.7606517153680407,-0.2976804326410209,-0.3317143673526655)
,
vec3(-0.629885905665492,-0.015077275989200908,-0.6249528775054316)
,
vec3(0.06817271749556833,0.10803586057963945,0.4400958745137948)
,
vec3(0.05474405139536939,0.25251129215297213,0.320629127592269)
,
vec3(0.0015364635396630953,-0.48110673948126786,0.0025642873912805775)
,
vec3(0.022263386955593704,-0.0008416012191450396,0.8067047886342416)
,
vec3(-0.044681095831345434,0.4263328312994823,-0.08718143343983795)
,
vec3(-0.07781034649655266,0.31491717410828335,-0.24278154906015567)
,
vec3(-0.33446840257269517,-0.10887735958732618,-0.20662905172844787)
,
vec3(-0.6817400096047624,-0.1465353889135788,-0.06333099184638523)
,
vec3(0.011961826799448388,-0.148668426593278,0.0015534633090358077)
,
vec3(-0.06225845770608123,0.5863764667452839,-0.11957987333834588)
,
vec3(0.21719330283822882,0.1974789291801585,0.4030071656921661)
,
vec3(-0.19548638668599563,-0.19190385681412156,-0.1419898750779333)
,
vec3(-0.028156099928103338,0.024779980354875872,-0.4296867063740601)
,
vec3(0.018836743496254582,0.00038290092490545646,0.5062773586555938)
,
vec3(-0.4346306651310619,-0.6575299873113633,-0.48878972654200326)
,
vec3(0.05058575754914446,0.004742899977110934,0.6767306345881264)
,
vec3(-0.10831809174714968,0.11301762296155882,-0.2044880025442427)
,
vec3(0.21379164746985152,0.05989642045706171,0.17362290990658935)
,
vec3(0.2577738756703525,0.2809475667126583,0.45058529950274767)
,
vec3(0.007553276398099948,0.40360474673187957,0.3728138775677017)
,
vec3(-0.16257101372508642,0.04112326823357288,-0.40843499246544523)
,
vec3(0.030996948913247363,0.0026343041122401578,0.08012275418044135)
,
vec3(-0.18262479625995967,-0.14973666334188449,-0.5224747466984921)
,
vec3(-0.2344185779519987,-0.6243886624013757,-0.2313293626274683)
,
vec3(0.04839438747689421,0.4584947992988792,0.0040944206321654525)
,
vec3(-0.3284975034207103,-0.01526498023702344,-0.7974133809438414)
,
vec3(0.04118310331032707,0.01323708027687493,0.9235192604073299)
,
vec3(-0.004775866786433263,0.7076591546941859,-0.005673840068392268)
,
vec3(0.17826155275754108,0.1633554027952672,0.33476597686684223)
,
vec3(-0.40358615337530246,0.23125249101795842,-0.08501767070475436)
,
vec3(-0.7124066642800744,0.30592117705310146,-0.6557324492847829)
,
vec3(-0.8001300705852686,-0.3515215450286599,-0.5198966941245666)
,
vec3(-0.3273770928945676,-0.14351735948415922,-0.3093451995727225)
,
vec3(-0.6109182158148372,0.533377823700775,-0.47376295111492744)
,
vec3(0.020814952935368072,-0.0021342236946738486,0.8232268555076286)
,
vec3(-0.11024532188261311,-0.23301470616057174,-0.667826327856235)
,
vec3(-0.2706763147459718,-0.043934388667186255,-0.06234586231719953)
,
vec3(-0.13214701938595105,0.2634580551507319,-0.11053672337945657)
,
vec3(-0.28687523902474427,-0.3897365250128697,-0.7129557459096407)
,
vec3(-0.01562948711817185,0.5942464233140149,-0.057518033321182854)
,
vec3(-0.4090449714179408,0.49919300808982525,-0.37343777426725405)
,
vec3(0.05104244560595092,-0.011811498185095567,0.3688426620847068)
,
vec3(0.038550245767095884,-0.18909529789321014,0.24676251801243576)
,
vec3(-0.17136933258390782,0.3457055445804186,-0.11240324767970294)
,
vec3(-0.9610842481945128,0.009424117956531319,-0.3995675444156673)
,
vec3(-0.679493903889684,0.46454692625558336,-0.09795487998437329)
,
vec3(0.08707108176000132,0.06465758248190068,0.03324800119374262)
,
vec3(0.040417698047215345,-0.06568835743214134,0.7998092041059488)
,
vec3(0.06921431781070495,-0.1623860203980017,0.04598216217833193)
,
vec3(0.0009666372359341546,0.6479185919451131,0.003926945794738987)
,
vec3(-0.06636785458551975,0.11657828476646444,-0.12410755303088261)
,
vec3(-0.6133780439897683,-0.00019520766334531604,-0.6761980410767052)
,
vec3(-0.3692600621105682,0.09842668857547623,-0.8390935147419456)
,
vec3(-0.05601380944000935,0.1363868345549419,-0.015155152693743791)
,
vec3(0.009499510610660076,0.4938953690001312,0.008456739851187651)
,
vec3(0.011052810068601758,-0.00888095281585712,0.24553064860663307)
,
vec3(-0.01023149893716419,-0.48271655427027105,-0.007586587167094133)
,
vec3(-0.33856227819488516,-0.4075553681588839,-0.10654912396550607)
,
vec3(-0.03956790087265826,0.5269603467906645,-0.055376973139595324)
,
vec3(-0.5628128047770707,-0.45484642223658284,-0.18439895400826997)
,
vec3(-0.0448217248179866,-0.2585628702464918,-0.057725853294009484)
,
vec3(0.06709703731115157,0.0028768679570241634,0.8215524935820043)
,
vec3(-0.22591231912137316,0.07160667949356901,-0.05491185538562301)
,
vec3(0.08482040534662089,-0.06911652709809851,0.140978393297514)
,
vec3(0.04209424760528909,-0.5364255332374033,0.01727603749687343)
,
vec3(-0.7681906326491235,0.2547726821932987,-0.4253011726412624)
,
vec3(0.0315665195902101,-0.2727941044431902,0.05970645459068854)
,
vec3(0.19373148709975765,0.05787833472127426,0.2158306647051313)
,
vec3(-0.21940695674523278,-0.3396602506386018,-0.1245965707932472)
,
vec3(-0.014648467282351089,0.36046957676775465,-0.21495930201093796)
,
vec3(-0.5227956650391814,0.040009520436120126,-0.5841260792139457)
,
vec3(0.08152930443436965,-0.009071899572488796,0.13523216980729816)
,
vec3(0.25194061014763397,0.17753413015201072,0.44406052799368945)
,
vec3(-0.5700228806059839,-0.09126681810169046,-0.2708268820588997)
,
vec3(0.021045699935654315,-0.09655972239964099,0.14798406253742707)
,
vec3(0.11922059627890923,-0.03494696754309449,0.8724710505734327)
,
vec3(-0.011878778731809907,0.476522231794563,-0.19558761486405032)
,
vec3(-0.0991789424409528,0.7392884804202398,-0.15883500692407407)
,
vec3(0.07433906978562188,0.3375119145268428,0.1034889052381173)
,
vec3(0.12202682698607359,0.10549996104169967,0.3174285775576973)
,
vec3(0.048678777384805236,0.05434287984789705,0.8734356317977346)
,
vec3(-0.7645925710904217,-0.03558950346154064,-0.5663392004800291)
,
vec3(0.021089743782832352,-0.05366464679102942,0.3915143315709217)
,
vec3(0.21792582734936097,-0.16295997109834806,0.252340674115419)
,
vec3(-0.08639127635443271,0.43652775323656495,-0.012676598069390359)
,
vec3(-0.544272660557614,-0.02731965653688662,-0.07920766378718364)
,
vec3(-0.6390381668322358,0.023836363637344836,-0.40584481623926894)
,
vec3(0.11901835044025887,0.24744959818470608,0.09145108787274922)
,
vec3(0.11940972291955905,-0.07668527661065012,0.11997173498551574)
,
vec3(-0.32023453037787375,0.3050738202622602,-0.2759775741234839)
,
vec3(0.04917292690731483,-0.004262690054221137,0.5845546199189247)
,
vec3(0.020859413426059868,-0.3266382404561074,0.30507213007196965)
,
vec3(-0.10979459429992885,-0.7129511421424916,-0.10570115165570006)
,
vec3(0.05482980448768056,0.004123291543695451,0.724356529932391)
,
vec3(-0.7488309937702607,0.08714750664112031,-0.9789565329971278)
,
vec3(0.08277280404043398,-0.043611475082237026,0.035605551725656416)
,
vec3(-0.1127060672150463,0.040764359378646586,-0.6056261282312335)
,
vec3(-0.019064714015096417,0.3331266972801239,-0.04067075026724692)
,
vec3(-0.059657854858495174,-0.21181943862992075,-0.7965765520142145)
,
vec3(-0.006519495642092373,0.28331256596789917,-0.6335576025732059)
,
vec3(0.23883836001584682,-0.0656888831740384,0.04612180846236204)
,
vec3(0.11176074545613283,0.11660444483518442,0.1250520701234751)
,
vec3(0.2470606065921271,-0.0685395400485146,0.533883414273626)
,
vec3(-0.2726062028089034,-0.2191770202736608,-0.2272627532826485)
,
vec3(-0.06393818232326111,-0.2567139492557835,-0.4722534265628438)
,
vec3(-0.06942939871193245,-0.5078438478698527,-0.2593873599629341)
,
vec3(0.12778300423788191,-0.15172313046856586,0.4192066322812044)
,
vec3(-0.003309041603139393,-0.46284677479302166,-0.0355291693214828)
,
vec3(0.032539419782914566,-0.0019961169934149293,0.831269679549159)
,
vec3(0.11382119291839733,-0.10262209925725628,0.2694557341521216)
,
vec3(0.017922273487626688,0.4597372415622287,0.14006690335700478)
,
vec3(-0.3467932697723212,0.15944513967070006,-0.26976410845314636)
,
vec3(0.1033480399225296,-0.10476254744830016,0.5663971109172006)
,
vec3(-0.05435809423053145,-0.5524629721652877,-0.21933952631402068)
,
vec3(-0.3388520207144855,-0.11419914758951624,-0.5641656192867923)
,
vec3(0.1920902081891517,-0.09539298823719644,0.6439981316422937)
,
vec3(-0.5205815274525606,0.006996046236114574,-0.38630609274026456)
,
vec3(0.06317698684891217,0.18763007866395598,0.45311510511298536)
,
vec3(-0.11413634227110878,0.16559978091044725,-0.10349078477094624)
,
vec3(0.007293915872042785,0.0028850751072557654,0.9363346470131886)
,
vec3(-0.7900400940366535,-0.24920815102052735,-0.42528134724636185)
,
vec3(-0.28939916859848464,0.3044181098959169,-0.3134541936443439)
,
vec3(-0.17923691678556028,0.0221415434111431,-0.11033922068180416)
,
vec3(-0.7613184463641429,0.39185590717571267,-0.39580112869495604)
,
vec3(0.1738398391761314,-0.12142935156025908,0.5893476659336608)
,
vec3(-0.053847075877878445,0.4453438644453598,-0.3451387498769794)
,
vec3(0.06199126136005299,-0.26237889625267247,0.501199419149455)
,
vec3(0.012244778788947518,0.010593115234450985,0.5966661961753053)
,
vec3(0.20953712285419512,-0.3044870196036907,0.16621665504757918)
,
vec3(-0.3560482711096824,-0.22686515996230358,-0.03388111347878711)
);



	const float rad = 0.0002f;
	const float total_strength = 1.0;
	const float base = 0.2;
  
	const float area = 0.0075;
	const float falloff = 0.000001;

float rand(vec2 co){
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}

float calcGI(vec3 normal, vec3 currentPos, int i, float radius, vec3 random)
{
		vec2 UVPos = UV + (normal * reflect(sphereSamples[i], random) * radius).xy;
		vec3 sampledNormal = 2.0f * texture2D(FNormal, UVPos).rgb - 1.0f;
		sampledNormal = normalize(sampledNormal);

		float val = dot(normal, sampledNormal);

		if(texture2D(FDepth, UVPos).r - currentPos.z > 0.2)val = 1;

		return clamp(val, 0, 1);
}

float calcGI_T(vec3 normal, vec3 position, int i, float radius_depth, vec3 random)
{
	vec3 ray = radius_depth * reflect(sphereSamples[i], random);
    vec3 hemi_ray = position + sign(dot(ray,normal)) * ray;
    
    float occ_depth = texture2D(FDepth, clamp(hemi_ray.xy, 0.0, 1.0)).r;
    float difference = position.z - occ_depth;
    
    return step(falloff, difference) * (1.0-smoothstep(falloff, area, difference));
}

void main(){

	vec3 normal = 2.0f * texture2D(FNormal, UV).rgb - 1.0f;		//Read in the front facing normal
	normal = normalize(normal);


	//Reconstruct current position
	vec3 currentPos = UV.xyx;
	currentPos.z = texture2D(FDepth, UV).r; 

	vec3 random = normalize(vec3(rand(UV), rand(normal.xy), rand(currentPos.xz)));

	float ao = 0;
  
	float radius = 0.0001;

	for(int i = 0; i < SAMPLES; i+=4)
	{
		ao += calcGI(normal, currentPos, i, radius, random);
		ao += calcGI(normal, currentPos, i + 1, radius, random);
		ao += calcGI(normal, currentPos, i + 2, radius, random);
		ao += calcGI(normal, currentPos, i + 3, radius, random);

		radius += 0.01f;
		//radius += rand(UV * 5000) * 0.0007;
		//radius *= 1.4f;
	}
	
	//ao = 1.0 - total_strength * ao * (1.0 / SAMPLES);
	ao = ao/SAMPLES;

	color = vec4(clamp(ao, 0.0, 1.0));
	color.a = 1;
}